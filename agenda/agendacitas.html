<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="agendacitas.css">
    <title>Agenda</title>
</head>

<body>
    <div class="all">
        <h1>Agenda de citas</h1>
        <hr>
        <div class="filtag">
            <div class="row">
                <div class="col-md-12">
                    <select class="form-select" aria-label="Default select example" id="filtroEstado">
                        <option value="todas" selected>Todas las citas</option>
                        <option value="pendiente">Pendientes</option>
                        <option value="agendada">Agendadas</option>
                        <option value="anulada">Anuladas</option>
                    </select>
                </div>
            </div>
            <div class="buscador">
                <div class="row">
                    <div class="col-md-12">
                        <input class="form-control" type="text" placeholder="Nombre de mascota o propietario"
                            id="buscador">
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                Agregar cita
            </button>
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div id="liveAlertPlaceholder"></div>
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Guardar nueva cita</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="container">
                                <input type="hidden" id="citaId">
                                <div class="row">
                                    <div class="col-md-12">
                                        <input type="text" class="form-control" id="nombre"
                                            placeholder="Nombre de la mascota">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <input type="text" class="form-control" id="propietario"
                                            placeholder="Propietario">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <input type="number" class="form-control" id="telefono" placeholder="Tel√©fono">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Fecha de la cita</label>
                                        <input type="date" class="form-control" id="fecha">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Hora de la cita</label>
                                        <input type="time" class="form-control" id="hora">
                                    </div>
                                </div>
                                <select class="form-select" aria-label="Default select example" id="tipo">
                                    <option value="" selected disabled>Tipo de mascota</option>
                                    <option value="Canino">Canino</option>
                                    <option value="Felino">Felino</option>
                                    <option value="Anfibio">Anfibio</option>
                                    <option value="Roedor">Roedor</option>
                                    <option value="Equino">Equino</option>
                                    <option value="Ave">Ave</option>
                                    <option value="Acu√°tico">Acu√°tico</option>
                                    <option value="Reptil">Reptil</option>
                                    <option value="Marsupial">Marsupial</option>
                                    <option value="Primate">Primate</option>
                                </select>
                                <div class="mb-3">
                                    <textarea class="form-control" id="sintomas" rows="3" placeholder="S√≠ntomas"
                                        wrap="none"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="limpiarFormulario()">Close</button>
                            <button type="button" class="btn btn-primary" id="save"
                                onclick="guardarCita()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div id="citasContainer"></div>

        <script>
            let datosCit = JSON.parse(localStorage.getItem('citas')) || [];
            let validacion = false;
            let editando = false;
            let citaEditandoId = null;
            let contadorId = datosCit.length > 0 ? Math.max(...datosCit.map(c => c.id)) + 1 : 1;
            
            const emojis = {
                Canino: "üê∂",
                Felino: "üê±",
                Anfibio: "üê∏",
                Roedor: "üê≠",
                Equino: "üê¥",
                Ave: "üê¶",
                Acu√°tico: "üê≥",
                Reptil: "üêç",
                Marsupial: "üê®",
                Primate: "üêµ"
            };

            document.addEventListener('DOMContentLoaded', function() {
                actualizarTodasLasTarjetas();
                
                document.getElementById('filtroEstado').addEventListener('change', actualizarTodasLasTarjetas);
                document.getElementById('buscador').addEventListener('input', actualizarTodasLasTarjetas);
                
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fecha').min = hoy;
            });

            function guardarCita() {
                if (!validaciones()) return;
                
                const datos = {
                    id: editando ? citaEditandoId : contadorId++,
                    nombreMascota: document.getElementById("nombre").value,
                    propietario: document.getElementById("propietario").value,
                    telefono: document.getElementById("telefono").value,
                    fecha: document.getElementById("fecha").value,
                    hora: document.getElementById("hora").value,
                    tipoMascota: document.getElementById("tipo").value,
                    sintomas: document.getElementById("sintomas").value,
                };

                if (editando) {
                    const citaOriginal = datosCit.find(c => c.id === citaEditandoId);
                    if (citaOriginal) {
                        datos.estado = citaOriginal.estado;
                    }
                    
                    const index = datosCit.findIndex(cita => cita.id === citaEditandoId);
                    if (index !== -1) {
                        datosCit[index] = datos;
                    }
                    editando = false;
                    citaEditandoId = null;
                } else {
                    datosCit.unshift(datos);
                }

                localStorage.setItem('citas', JSON.stringify(datosCit));
                actualizarTodasLasTarjetas();
                const modal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
                modal.hide();
                limpiarFormulario();
            }

            function actualizarTodasLasTarjetas() {
                const estadoFiltro = document.getElementById('filtroEstado').value;
                const textoBusqueda = document.getElementById('buscador').value.toLowerCase();
                const citasFiltradas = datosCit.filter(cita => {
                    const coincideEstado = estadoFiltro === 'todas' || cita.estado === estadoFiltro;
                    const coincideBusqueda = 
                        cita.nombreMascota.toLowerCase().includes(textoBusqueda) || 
                        cita.propietario.toLowerCase().includes(textoBusqueda);
                    
                    return coincideEstado && coincideBusqueda;
                });
                
                const contenedor = document.getElementById("citasContainer");
                contenedor.innerHTML = '';

                citasFiltradas.forEach(datos => {
                    const card = document.createElement("div");
                    card.className = "card mb-3";
                    card.style.width = "18rem";
                    card.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${datos.nombreMascota} <small class="text-muted">#${datos.id}</small></h5>
                            <span class="emoji">${emojis[datos.tipoMascota]}</span>
                            <p class="card-text">Tipo: ${datos.tipoMascota}</p>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Propietario: ${datos.propietario}</li>
                            <li class="list-group-item">Tel√©fono: ${datos.telefono}</li>
                            <li class="list-group-item">Fecha: ${datos.fecha}</li>
                            <li class="list-group-item">Hora: ${datos.hora}</li>
                            <li class="list-group-item">S√≠ntomas: ${datos.sintomas}</li>
                            <li class="list-group-item">
                                <select class="form-select estado-cita" data-id="${datos.id}" aria-label="Estado de la cita">
                                    <option value="pendiente" ${datos.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="agendada" ${datos.estado === 'agendada' ? 'selected' : ''}>Agendada</option>
                                    <option value="anulada" ${datos.estado === 'anulada' ? 'selected' : ''}>Anulada</option>
                                </select>
                            </li>
                        </ul>
                        <div class="card-footer">
                            <button class="btn btn-success btn-sm" onclick="editarCita(${datos.id})">
                                <i class="material-icons">drive_file_rename_outline</i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCita(${datos.id})">
                                <i class="material-icons">delete</i> Eliminar
                            </button>
                        </div>
                    `;
                    contenedor.appendChild(card);
                });
                
                document.querySelectorAll('.estado-cita').forEach(select => {
                    select.addEventListener('change', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const nuevoEstado = this.value;
                        actualizarEstadoCita(id, nuevoEstado);
                    });
                });
            }

            function actualizarEstadoCita(id, nuevoEstado) {
                const index = datosCit.findIndex(cita => cita.id === id);
                if (index !== -1) {
                    datosCit[index].estado = nuevoEstado;
                    localStorage.setItem('citas', JSON.stringify(datosCit));
                }
            }

            function eliminarCita(id) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta cita?')) {
                    datosCit = datosCit.filter(cita => cita.id !== id);
                    localStorage.setItem('citas', JSON.stringify(datosCit));
                    actualizarTodasLasTarjetas();
                }
            }

            function editarCita(id) {
                const cita = datosCit.find(cita => cita.id === id);
                if (cita) {
                    document.getElementById("nombre").value = cita.nombreMascota;
                    document.getElementById("propietario").value = cita.propietario;
                    document.getElementById("telefono").value = cita.telefono;
                    document.getElementById("fecha").value = cita.fecha;
                    document.getElementById("hora").value = cita.hora;
                    document.getElementById("tipo").value = cita.tipoMascota;
                    document.getElementById("sintomas").value = cita.sintomas;
                    document.getElementById("citaId").value = cita.id;
                    
                    editando = true;
                    citaEditandoId = id;
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
                    document.getElementById('exampleModalLabel').textContent = 'Editando cita';
                    document.getElementById('save').textContent = 'Guardar edici√≥n';
                    modal.show();
                }
            }

            function alerta(message, type) {
                const alertPlaceholder = document.getElementById('liveAlertPlaceholder');
                const wrapper = document.createElement('div');
                wrapper.innerHTML = [
                    `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                    `   <div>${message}</div>`,
                    '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                    '</div>'
                ].join('');
                setTimeout(() => {
                    wrapper.remove();
                }, 3000);

                alertPlaceholder.append(wrapper);
            }

            function validaciones() {
                if (document.getElementById("nombre").value == "" || 
                    document.getElementById("propietario").value == "" || 
                    document.getElementById("telefono").value == "" || 
                    document.getElementById("fecha").value == "" || 
                    document.getElementById("hora").value == "" || 
                    document.getElementById("tipo").value == "" || 
                    document.getElementById("sintomas").value == "") {
                    alerta('Todos los campos son obligatorios!', 'danger');
                    return false;
                }
                
                if (document.getElementById("telefono").value.length !==10) {
                    alerta('El tel√©fono debe tener como m√≠nimo 10 d√≠gitos.', 'danger');
                    return false;
                }
                
                return true;
            }

            function limpiarFormulario() {
                document.getElementById("citaId").value = "";
                document.getElementById("nombre").value = "";
                document.getElementById("propietario").value = "";
                document.getElementById("telefono").value = "";
                document.getElementById("fecha").value = "";
                document.getElementById("hora").value = "";
                document.getElementById("tipo").value = "";
                document.getElementById("sintomas").value = "";
                
                document.getElementById('exampleModalLabel').textContent = 'Guardar nueva cita';
                document.getElementById('save').textContent = 'Save';
                
                editando = false;
                citaEditandoId = null;
            }
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
</body>
</html>